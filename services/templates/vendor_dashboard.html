<script>
// Notification system
function setupNotifications() {
    // Check for notification permission
    if (Notification.permission !== 'granted') {
        Notification.requestPermission();
    }

    // WebSocket connection for real-time notifications
    const socket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/notifications/' + vendorId + '/'
    );

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        
        // Handle new order notification
        if (data.type === 'new_order') {
            showNotification('New Order Received', {
                body: `New order #${data.order_id} received from ${data.customer_name}`,
                icon: '/static/images/notification-icon.png',
                tag: `order-${data.order_id}`,
                data: { orderId: data.order_id }
            });
            
            // Update orders list
            updateOrdersList(data.order);
            
            // Show toast notification
            showToast('New Order', `Order #${data.order_id} received from ${data.customer_name}`, 'success');
            
            // Play notification sound
            playNotificationSound();
        }
    };

    socket.onclose = function(e) {
        console.log('WebSocket connection closed, attempting to reconnect...');
        setTimeout(setupNotifications, 1000);
    };
}

function showNotification(title, options) {
    if (Notification.permission === 'granted') {
        const notification = new Notification(title, options);
        notification.onclick = function(event) {
            event.preventDefault();
            window.focus();
            if (options.data && options.data.orderId) {
                showOrderDetails(options.data.orderId);
            }
        };
    }
}

function updateOrdersList(order) {
    const ordersList = document.querySelector('#orders-list');
    const newOrderHtml = `
        <div class="order-item new-order" data-order-id="${order.id}">
            <div class="order-header">
                <h5>Order #${order.id}</h5>
                <span class="badge bg-success">New</span>
            </div>
            <div class="order-details">
                <p><strong>Customer:</strong> ${order.customer_name}</p>
                <p><strong>Total:</strong> â‚¹${order.total_amount}</p>
                <p><strong>Items:</strong> ${order.items.length}</p>
            </div>
            <div class="order-actions">
                <button class="btn btn-primary btn-sm" onclick="viewOrder(${order.id})">
                    <i class="fas fa-eye"></i> View Details
                </button>
                <button class="btn btn-success btn-sm" onclick="acceptOrder(${order.id})">
                    <i class="fas fa-check"></i> Accept
                </button>
            </div>
        </div>
    `;
    ordersList.insertAdjacentHTML('afterbegin', newOrderHtml);
    
    // Highlight new order with animation
    setTimeout(() => {
        document.querySelector(`[data-order-id="${order.id}"]`).classList.add('show');
    }, 100);
}

function playNotificationSound() {
    const audio = new Audio('/static/sounds/notification.mp3');
    audio.play().catch(error => console.log('Error playing notification sound:', error));
}

// Toast notification system
function showToast(title, message, type = 'info') {
    const toastContainer = document.querySelector('.toast-container') || createToastContainer();
    const toast = document.createElement('div');
    toast.className = `toast ${type} show`;
    toast.innerHTML = `
        <div class="toast-header">
            <i class="fas fa-${getToastIcon(type)} me-2"></i>
            <strong class="me-auto">${title}</strong>
            <button type="button" class="btn-close" onclick="this.closest('.toast').remove()"></button>
        </div>
        <div class="toast-body">${message}</div>
    `;
    
    toastContainer.appendChild(toast);
    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
    }, 5000);
}

function createToastContainer() {
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    document.body.appendChild(container);
    return container;
}

// Order status update handling
function updateOrderStatus(orderId, status) {
    fetch('/update_order_status/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            order_id: orderId,
            status: status,
            completion_time: status === 'Delivered' ? new Date().toISOString() : null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Success', `Order #${orderId} ${status}`, 'success');
            updateOrderStatusUI(orderId, status);
            
            // Notify customer about status update
            notifyCustomer(orderId, status);
        } else {
            showToast('Error', data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'Failed to update order status', 'error');
    });
}

function notifyCustomer(orderId, status) {
    // Send notification to customer via WebSocket
    if (socket && socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({
            type: 'status_update',
            order_id: orderId,
            status: status
        }));
    }
}

// Add styles
const style = document.createElement('style');
style.textContent = `
    .order-item {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.3s ease;
    }
    
    .order-item.show {
        opacity: 1;
        transform: translateY(0);
    }
    
    .order-item.new-order {
        border-left: 4px solid #28a745;
    }
    
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .order-details {
        margin-bottom: 1rem;
    }
    
    .order-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .toast-container {
        z-index: 1050;
    }
    
    .toast {
        min-width: 300px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        margin-bottom: 1rem;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
    }
    
    .toast.show {
        opacity: 1;
        transform: translateX(0);
    }
    
    .toast.success { border-left: 4px solid #28a745; }
    .toast.error { border-left: 4px solid #dc3545; }
    .toast.warning { border-left: 4px solid #ffc107; }
    .toast.info { border-left: 4px solid #17a2b8; }
`;
document.head.appendChild(style);

// Initialize notifications when page loads
document.addEventListener('DOMContentLoaded', function() {
    setupNotifications();
});
</script> 